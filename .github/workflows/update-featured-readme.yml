name: Auto-Update Featured AI/ML Projects

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  update-featured-projects:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate Featured Projects (All Private Repos)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: Akshay-Ramesh-VITC
        run: |
          python3 << 'EOF'
          import os
          import requests
          from datetime import datetime

          token = os.environ['GH_TOKEN']
          username = os.environ['USERNAME']
          
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # Fetch all repositories
          print("Fetching all repositories...")
          all_repos = []
          page = 1
          
          while True:
              url = f'https://api.github.com/user/repos?affiliation=owner&per_page=100&page={page}'
              response = requests.get(url, headers=headers)
              
              if response.status_code != 200:
                  print(f"Error: {response.status_code}")
                  break
                  
              repos = response.json()
              if not repos:
                  break
                  
              all_repos.extend(repos)
              page += 1

          print(f"Found {len(all_repos)} total repositories")

          # Separate public AI/ML and all private repos
          ai_ml_keywords = [
              'machine-learning', 'ml', 'ai', 'artificial-intelligence',
              'deep-learning', 'neural-network', 'tensorflow', 'pytorch',
              'computer-vision', 'nlp', 'data-science', 'kaggle',
              'classification', 'regression', 'clustering', 'prediction',
              'heart', 'disease', 'medical', 'health', 'platform'
          ]

          public_ai_ml = []
          private_repos = []
          
          for repo in all_repos:
              # Skip the profile README repo itself
              if repo.get('name') == username:
                  continue
                  
              if repo.get('private', False):
                  # Add ALL private repos
                  private_repos.append(repo)
              else:
                  # Only add public repos if they're AI/ML related
                  repo_name_lower = repo.get('name', '').lower()
                  description_lower = (repo.get('description') or '').lower()
                  topics = repo.get('topics', [])
                  
                  is_ai_ml = any(
                      keyword in repo_name_lower or 
                      keyword in description_lower or 
                      keyword in topics
                      for keyword in ai_ml_keywords
                  )
                  
                  if is_ai_ml:
                      public_ai_ml.append(repo)

          # Sort each group by stars, then by update date
          public_ai_ml.sort(
              key=lambda x: (x.get('stargazers_count', 0), x.get('updated_at', '')), 
              reverse=True
          )
          private_repos.sort(
              key=lambda x: (x.get('stargazers_count', 0), x.get('updated_at', '')), 
              reverse=True
          )

          # Combine: public AI/ML first, then private repos (up to 8 total)
          featured_repos = (public_ai_ml + private_repos)[:8]

          print(f"\n{'='*60}")
          print("FEATURED REPOSITORIES:")
          print(f"{'='*60}")
          print(f"Public AI/ML projects: {len(public_ai_ml)}")
          print(f"Private projects: {len(private_repos)}")
          print(f"Total featured: {len(featured_repos)}")
          print(f"{'='*60}\n")

          for repo in featured_repos:
              is_private = repo.get('private', False)
              privacy = "üîí PRIVATE" if is_private else "üåê Public"
              stars = repo.get('stargazers_count', 0)
              name = repo.get('name', 'Unknown')
              print(f"  ‚Ä¢ {name:<40} {privacy:<15} ‚≠ê {stars}")

          # Generate markdown table
          projects_md = "### üöÄ Featured AI/ML Projects\n\n"
          
          if len(featured_repos) > 0:
              projects_md += "| Project | Description | Language | Status | Stars |\n"
              projects_md += "|---------|-------------|----------|--------|-------|\n"
              
              for repo in featured_repos:
                  repo_name = repo.get('name', 'Unknown')
                  repo_url = repo.get('html_url', '#')
                  description = (repo.get('description') or 'Project')
                  
                  # Truncate long descriptions
                  if len(description) > 50:
                      description = description[:47] + '...'
                  
                  language = repo.get('language') or 'Code'
                  stars = repo.get('stargazers_count', 0)
                  is_private = repo.get('private', False)
                  
                  # Status badge
                  if is_private:
                      status_badge = "![Private](https://img.shields.io/badge/Private-red?style=flat-square&logo=github)"
                  else:
                      status_badge = "![Public](https://img.shields.io/badge/Public-green?style=flat-square&logo=github)"
                  
                  # Language badge
                  lang_color = {
                      'Python': '3776AB',
                      'JavaScript': 'F7DF1E',
                      'Java': '007396',
                      'C++': '00599C',
                      'C': 'A8B9CC',
                      'TypeScript': '3178C6',
                      'HTML': 'E34F26',
                      'CSS': '1572B6'
                  }.get(language, '808080')
                  
                  lang_badge = f"![{language}](https://img.shields.io/badge/{language}-{lang_color}?style=flat-square)"
                  
                  # Project name as link
                  name_link = f"**[{repo_name}]({repo_url})**"
                  
                  projects_md += f"| {name_link} | {description} | {lang_badge} | {status_badge} | ‚≠ê {stars} |\n"
          else:
              projects_md += "*No projects found*\n"

          private_count = sum(1 for r in featured_repos if r.get('private', False))
          public_count = len(featured_repos) - private_count

          projects_md += f"\n*ü§ñ Auto-updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')} ‚Ä¢ "
          projects_md += f"{len(featured_repos)} projects ({public_count} public, {private_count} private)*\n"

          # Save to file
          with open('featured_projects.md', 'w', encoding='utf-8') as f:
              f.write(projects_md)

          print("\n" + "="*60)
          print("GENERATED MARKDOWN:")
          print("="*60)
          print(projects_md)
          print("="*60)

          EOF

      - name: Update README
        run: |
          if grep -q "<!-- FEATURED_PROJECTS_START -->" README.md && grep -q "<!-- FEATURED_PROJECTS_END -->" README.md; then
            sed -n '1,/<!-- FEATURED_PROJECTS_START -->/p' README.md > temp_readme.md
            cat featured_projects.md >> temp_readme.md
            sed -n '/<!-- FEATURED_PROJECTS_END -->/,$p' README.md >> temp_readme.md
            mv temp_readme.md README.md
            echo "‚úÖ README updated successfully"
          else
            echo "‚ùå Error: Markers not found in README.md"
            echo "Please ensure <!-- FEATURED_PROJECTS_START --> and <!-- FEATURED_PROJECTS_END --> exist in README.md"
            exit 1
          fi

      - name: Commit changes
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          git add README.md
          
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "üöÄ Auto-update featured projects (including private repos) [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ Changes pushed successfully"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ‚úÖ Workflow Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Featured projects section updated with public and private repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **Updated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
