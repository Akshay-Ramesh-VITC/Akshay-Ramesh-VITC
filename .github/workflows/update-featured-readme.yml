name: Auto-Update Featured AI/ML Projects

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  update-featured-projects:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pillow

      - name: Generate Featured Projects
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: Akshay-Ramesh-VITC
        run: |
          python3 << 'EOF'
          import os
          import requests
          from datetime import datetime

          token = os.environ['GH_TOKEN']
          username = os.environ['USERNAME']
          
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # Fetch all repositories
          print("Fetching repositories...")
          all_repos = []
          page = 1
          
          while True:
              url = f'https://api.github.com/user/repos?affiliation=owner&per_page=100&page={page}'
              response = requests.get(url, headers=headers)
              
              if response.status_code != 200:
                  print(f"Error: {response.status_code}")
                  break
                  
              repos = response.json()
              if not repos:
                  break
                  
              all_repos.extend(repos)
              page += 1

          print(f"Found {len(all_repos)} repositories")

          # Filter AI/ML projects
          ai_ml_keywords = [
              'machine-learning', 'ml', 'ai', 'artificial-intelligence',
              'deep-learning', 'neural-network', 'tensorflow', 'pytorch',
              'computer-vision', 'nlp', 'data-science', 'kaggle',
              'classification', 'regression', 'clustering', 'prediction',
              'heart', 'disease', 'medical', 'health'
          ]

          featured_repos = []
          
          for repo in all_repos:
              repo_name_lower = repo['name'].lower()
              description_lower = (repo.get('description') or '').lower()
              topics = repo.get('topics', [])
              
              is_ai_ml = any(
                  keyword in repo_name_lower or 
                  keyword in description_lower or 
                  keyword in topics
                  for keyword in ai_ml_keywords
              )
              
              if is_ai_ml:
                  featured_repos.append(repo)

          # Sort by stars and updates
          featured_repos.sort(
              key=lambda x: (x['stargazers_count'], x['updated_at']), 
              reverse=True
          )
          featured_repos = featured_repos[:6]

          print(f"\nFeatured repositories:")
          for repo in featured_repos:
              privacy = "üîí PRIVATE" if repo['private'] else "üåê Public"
              print(f"  - {repo['name']} ({privacy}) ‚≠ê{repo['stargazers_count']}")

          # Generate markdown with custom badges
          projects_md = "### üöÄ Featured AI/ML Projects\n\n"
          projects_md += "<div align=\"center\">\n\n"

          # Color scheme for badges
          colors = ['red', 'blue', 'green', 'purple', 'orange', 'pink']
          
          for idx, repo in enumerate(featured_repos):
              repo_name = repo['name']
              repo_url = repo['html_url']
              description = repo.get('description', 'AI/ML Project')[:50]
              language = repo.get('language', 'Python')
              stars = repo['stargazers_count']
              is_private = repo['private']
              color = colors[idx % len(colors)]
              
              # Privacy badge
              privacy_badge = "üîí_Private" if is_private else "üåê_Public"
              
              # Create custom badge
              badge_label = repo_name.replace('-', '_').replace(' ', '_')
              badge_url = f"https://img.shields.io/badge/{badge_label}-{language}-{color}?style=for-the-badge&logo=github"
              
              projects_md += f'<a href="{repo_url}">\n'
              projects_md += f'  <img src="{badge_url}" alt="{repo_name}" />\n'
              projects_md += '</a>\n'
              projects_md += f'<br/>\n'
              projects_md += f'<sub>{privacy_badge} ‚Ä¢ ‚≠ê {stars} ‚Ä¢ {description}</sub>\n\n'

          projects_md += "</div>\n\n"
          projects_md += f"*ü§ñ Auto-updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}*\n"

          # Save to file
          with open('featured_projects.md', 'w', encoding='utf-8') as f:
              f.write(projects_md)

          print("\n" + "="*50)
          print(projects_md)
          print("="*50)

          EOF

      - name: Update README
        run: |
          if grep -q "<!-- FEATURED_PROJECTS_START -->" README.md; then
            sed -n '1,/<!-- FEATURED_PROJECTS_START -->/p' README.md > temp_readme.md
            cat featured_projects.md >> temp_readme.md
            sed -n '/<!-- FEATURED_PROJECTS_END -->/,$p' README.md >> temp_readme.md
            mv temp_readme.md README.md
          else
            echo "Error: Markers not found"
            exit 1
          fi

      - name: Commit changes
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          git add README.md
          git diff --staged --quiet || (git commit -m "üöÄ Update featured projects [$(date +'%Y-%m-%d')]" && git push)
