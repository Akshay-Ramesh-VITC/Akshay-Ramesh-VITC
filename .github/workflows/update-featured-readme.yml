name: Auto-Update Featured AI/ML Projects

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  update-featured-projects:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate Featured Projects with Private Repos
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: Akshay-Ramesh-VITC
        run: |
          python3 << 'EOF'
          import os
          import requests
          from datetime import datetime
          import json

          token = os.environ['GH_TOKEN']
          username = os.environ['USERNAME']
          
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # Fetch all repositories
          print("Fetching repositories...")
          all_repos = []
          page = 1
          
          while True:
              url = f'https://api.github.com/user/repos?affiliation=owner&per_page=100&page={page}'
              response = requests.get(url, headers=headers)
              
              if response.status_code != 200:
                  print(f"Error: {response.status_code}")
                  break
                  
              repos = response.json()
              if not repos:
                  break
                  
              all_repos.extend(repos)
              page += 1

          print(f"Found {len(all_repos)} total repositories")

          # Filter AI/ML projects
          ai_ml_keywords = [
              'machine-learning', 'ml', 'ai', 'artificial-intelligence',
              'deep-learning', 'neural-network', 'tensorflow', 'pytorch',
              'computer-vision', 'nlp', 'data-science', 'kaggle',
              'classification', 'regression', 'clustering', 'prediction',
              'heart', 'disease', 'medical', 'health', 'platform'
          ]

          featured_repos = []
          
          for repo in all_repos:
              repo_name_lower = repo.get('name', '').lower()
              description_lower = (repo.get('description') or '').lower()
              topics = repo.get('topics', [])
              
              is_ai_ml = any(
                  keyword in repo_name_lower or 
                  keyword in description_lower or 
                  keyword in topics
                  for keyword in ai_ml_keywords
              )
              
              if is_ai_ml:
                  featured_repos.append(repo)

          # Sort by private first (to prioritize), then by stars
          featured_repos.sort(
              key=lambda x: (not x.get('private', False), -x.get('stargazers_count', 0), x.get('updated_at', '')), 
              reverse=False
          )
          featured_repos = featured_repos[:6]

          print(f"\nFeatured AI/ML repositories (including private):")
          private_count = 0
          public_count = 0
          for repo in featured_repos:
              is_private = repo.get('private', False)
              privacy = "üîí PRIVATE" if is_private else "üåê Public"
              stars = repo.get('stargazers_count', 0)
              print(f"  - {repo.get('name', 'Unknown')} ({privacy}) ‚≠ê{stars}")
              if is_private:
                  private_count += 1
              else:
                  public_count += 1

          print(f"\nSummary: {private_count} private, {public_count} public")

          # Generate markdown - using table format for better visibility
          projects_md = "### üöÄ Featured AI/ML Projects\n\n"
          
          if len(featured_repos) > 0:
              projects_md += "| Project | Description | Language | Privacy | Stars |\n"
              projects_md += "|---------|-------------|----------|---------|-------|\n"
              
              for repo in featured_repos:
                  repo_name = repo.get('name', 'Unknown')
                  repo_url = repo.get('html_url', '#')
                  description = (repo.get('description') or 'AI/ML Project')
                  if len(description) > 60:
                      description = description[:57] + '...'
                  language = repo.get('language') or 'Python'
                  stars = repo.get('stargazers_count', 0)
                  is_private = repo.get('private', False)
                  
                  privacy_icon = "üîí Private" if is_private else "üåê Public"
                  
                  # Create clickable link
                  name_link = f"[{repo_name}]({repo_url})"
                  
                  # Language badge
                  lang_badge = f"![{language}](https://img.shields.io/badge/{language}-informational?style=flat&logo=python&logoColor=white&color=2bbc8a)"
                  
                  projects_md += f"| {name_link} | {description} | {lang_badge} | {privacy_icon} | ‚≠ê {stars} |\n"
          else:
              projects_md += "*No AI/ML projects found*\n"

          projects_md += f"\n*ü§ñ Auto-updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')} ‚Ä¢ Showing {len(featured_repos)} AI/ML projects ({private_count} private, {public_count} public)*\n"

          # Save to file
          with open('featured_projects.md', 'w', encoding='utf-8') as f:
              f.write(projects_md)

          print("\n" + "="*60)
          print("Generated markdown preview:")
          print("="*60)
          print(projects_md)
          print("="*60)

          EOF

      - name: Update README
        run: |
          if grep -q "<!-- FEATURED_PROJECTS_START -->" README.md && grep -q "<!-- FEATURED_PROJECTS_END -->" README.md; then
            sed -n '1,/<!-- FEATURED_PROJECTS_START -->/p' README.md > temp_readme.md
            cat featured_projects.md >> temp_readme.md
            sed -n '/<!-- FEATURED_PROJECTS_END -->/,$p' README.md >> temp_readme.md
            mv temp_readme.md README.md
            echo "‚úÖ README updated successfully"
          else
            echo "‚ùå Error: Markers not found in README.md"
            exit 1
          fi

      - name: Commit changes
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          git add README.md
          
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "üöÄ Auto-update featured AI/ML projects (including ${PRIVATE_COUNT:-0} private) [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ Changes pushed successfully"
          fi
